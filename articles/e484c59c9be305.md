---
title: "RAID障害から学ぶfstabとsystemdの落とし穴"
emoji: "⚡"
type: "tech"
topics: [linux, raid, fstab, systemd, 教材化]
published: false
---

## 導入
RAIDは冗長化による安心感を与える一方で、障害時には複雑さが復旧を難しくする。  
特にfstabやsystemdと絡むと、単なるディスク障害が「OSが立ち上がらない」という深刻な事態に発展する。  

本記事では、実際に遭遇したRAID障害を題材に、  
- どのように切り分けを進めたか  
- どのような判断で再構成に至ったか  
- そこから抽出できる「構成判断の思考プロセス」  

を記録し、教材化していく。  

---

## 障害の再現・状況説明
今回の環境は、学習用に構築した Linux サーバで、RAID1（ミラーリング）を利用していた。  

- OS: Ubuntu 20.04 LTS  
- ディスク構成: /dev/sda, /dev/sdb を RAID1 で構成  
- マウント設定: /etc/fstab に RAID デバイス（/dev/md0）を記述  

再起動を行ったところ、ブートプロセスが途中で停止し、以下のようなメッセージが表示された。

/dev/md0 does not exist
Dependency failed for /mnt/data

この時点でシステムはシングルユーザーモードに落ち、通常のログインができない状態になった。  
「RAIDが壊れたのか？」「fstabの記述が悪いのか？」「systemdの依存関係か？」と、原因の切り分けが必要になった。  

---

## 調査の思考ログ
ブート時に `/dev/md0 does not exist` と表示された時点で、まず考えたのは「RAIDデバイスが正しく認識されていないのではないか」という点だった。  
ここから、以下の順番で切り分けを進めた。  

1. **RAIDデバイスの状態確認**  
   - `cat /proc/mdstat` → `md0` が存在せず。  

2. **ディスクデバイスの確認**  
   - `lsblk` / `fdisk -l` → `/dev/sda` と `/dev/sdb` は認識されていた。  

3. **RAIDメタデータの調査**  
   - `mdadm --examine /dev/sd[a-b]` → 片方のディスクに不整合あり。  

4. **fstabの影響切り分け**  
   - `/etc/fstab` に `/dev/md0` を直接指定 → systemdが依存関係を解決できず起動失敗。  

5. **systemdログの確認**  
   - `journalctl -xb` → `/mnt/data` のマウント失敗が原因で複数サービスが連鎖的に失敗。  

---

## 解決策と再構成
調査の結果、RAIDアレイが自動的に組み上がらず、fstabの記述が原因でブートが止まっていたことが分かった。  
そこで、以下の手順で復旧を行った。  

1. **一時的な起動回避**  
   - fstabに `nofail` を追加 → システム起動を継続可能に。  

2. **RAIDアレイの再構築**  
   - `mdadm --assemble --scan` で手動再構築。  
   - `mdadm --add` で不整合ディスクを再同期。  

3. **fstabの修正**  
   - `/dev/md0` ではなくUUIDを指定。  
   - `blkid` でUUIDを確認し反映。  

4. **systemd依存関係の再読み込み**  
   - `systemctl daemon-reload` → `systemctl status` で正常動作を確認。  

5. **再起動テスト**  
   - RAIDアレイが自動的に組み上がり、fstabのマウントが成功することを確認。  

---

## 学びの抽出（教材化ポイント）
今回のRAID障害対応から得られた学びは、単なる手順の暗記ではなく「判断基準の言語化」にある。  

- **RAIDは万能ではない**  
  冗長化は安心を与えるが、障害時には複雑さが増す。  

- **fstabの記述はシステム全体に影響する**  
  UUID指定や `nofail` の活用は再発防止の基本。  

- **systemdの依存関係を理解することが重要**  
  単なるマウント失敗が、複数のサービス停止に連鎖する。  

- **思考ログを残すことが教材化につながる**  
  「なぜその判断をしたのか」を記録することで、他者教育や再利用可能な教材資産に変換できる。